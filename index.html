<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
<body style="background-image: url('https://royalfarwe-s.schools.nsw.gov.au/content/dam/doe/sws/schools/r/royalfarwe-s/gallery/our-school/School_Outside.JPG.thumb.1280.1280.jpg');">
  <link rel="apple-touch-icon" sizes="180x180" href="assets/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://uat.royalfarwest.org.au/app/assets/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://uat.royalfarwest.org.au/app/assets/images/favicon-16x16.png">
<!--script src="site.js"></script-->
<div class="container" style="text-align: center; background: white;height: 500px;border-radius: 20px;border: 2px solid;margin-top: 50px;" onload="CheckPages()">
<div class="row" style="padding-top: 20px; margin-top: 20px;">
  <div class="col-md-12">
      <h2>RFW - Current Status: </h2>
      <h2 id="SystemStatus"></h2>
  </div>
</div>
  <!--div><img style="height: 80px;position: absolute;right: 83px;top: 72px;" src="https://www.royalfarwest.org.au/wp-content/uploads/2018/04/RFW-Master-Logo-Stacked-RGB-2017-insta.jpg"></div-->

<div style="padding-bottom: 20px; text-align: center;">Last refresh: <span id="time"></span></div>



<table class="table table-gray">
  <thead>
    <tr>
      <th scope="col">#</th>
      <th scope="col">System</th>
      <th scope="col">Status</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th scope="row">1</th>
      <td id="ConnectIntergrationTitle">Connect Integration</td>
      <td id="ConnectIntergrationStatus"></td>
    </tr>
    <tr>
      <th scope="row">2</th>
      <td>Lucy</td>
      <td>N/A</td>
    </tr>
    <tr>
      <th scope="row">3</th>
      <td>Connect Website</td>
      <td>N/A</td>
    </tr>
  </tbody>
</table>
</div>
</body>

<script>
  window.onload = function() {
    GetConnectToken()
    //CheckConnectIntergration()
    refreshPageTimer()
    setpagetime()
  }

  function refreshPageTimer() {
    setTimeout(function(){
      location.reload();
    }, 60000);
  }



  function setpagetime() {
    var today = new Date();
    var time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
    $('#time')[0].innerHTML = time;
  }



  function GetConnectToken() {
    var user = window.location.href.split("%27")[1];
    var password = window.location.href.split("%27")[3];

    //console.log(user + " " + password)

    $.ajax({
  //curl -H "Content-Type: application/json" -X GET -H "X-Auth-Token: 791a0df3-0526-463c-8217-f9702430215a" "https://online.royalfarwest.org.au/app/api/external-emr/filter?page=1&pageSize=100"
         'url' : 'https://online.royalfarwest.org.au/app/api/login',
         'type' : 'POST',
         'Content-Type' : 'application/json',
         'data' : 'username=' + user + '&password=' + password,
         'success' : function(data) {
           //console.log(data.split('"')[3])
           CheckConnectIntergration(data.split('"')[3]);
         },
         'error' : function(request,error){
           $('#ConnectIntergrationStatus')[0].innerHTML = 'FAILING - Cannot Login';
           $('#ConnectIntergrationStatus')[0].style.color = 'red';
           $('#ConnectIntergrationTitle')[0].style.color = 'red';
           $('#ConnectIntergrationStatus')[0].classList.add('FAILED');
           $('#ConnectIntergrationTitle')[0].classList.add('FAILED');
           SetSystemStatus()
         }
         });
  }

  function CheckConnectIntergration(token) {
  $.ajax({
  //curl -H "Content-Type: application/json" -X GET -H "X-Auth-Token: 791a0df3-0526-463c-8217-f9702430215a" "https://online.royalfarwest.org.au/app/api/external-emr/filter?page=1&pageSize=100"

         'url' : 'https://online.royalfarwest.org.au/app/api/external-emr/filter?page=1&pageSize=25',
         'type' : 'GET',
         'Content-Type' : 'application/json',
          headers: {
          'X-Auth-Token' : token,
         },
         'success' : function(data) {
             var failed = false
             var count = 0
             for (let i = 0; i < data.content.length; i++) {
               console.log(data.content[i].successful)
               if(data.content[i].successful == false){
                 count = count + 1;
                 if(count => 3){
                   failed = true
                   $('#ConnectIntergrationStatus')[0].innerHTML = 'FAILING';
                   $('#ConnectIntergrationStatus')[0].style.color = 'red';
                   $('#ConnectIntergrationTitle')[0].style.color = 'red';
                   $('#ConnectIntergrationStatus')[0].classList.add('FAILED');
                   $('#ConnectIntergrationTitle')[0].classList.add('FAILED');
                   break
                 }
               }
             }
             if(failed == false){
               $('#ConnectIntergrationStatus')[0].innerHTML = 'PASSING';
               $('#ConnectIntergrationStatus')[0].style.color = 'Green';
               $('#ConnectIntergrationTitle')[0].style.color = 'Green';
             }
             SetSystemStatus()
         },
         'error' : function(request,error)
         {
             $('#ConnectIntergrationStatus')[0].innerHTML = 'FAILING';
             $('#ConnectIntergrationStatus')[0].style.color = 'red';
             $('#ConnectIntergrationTitle')[0].style.color = 'red';
             $('#ConnectIntergrationStatus')[0].classList.add('FAILED');
             $('#ConnectIntergrationTitle')[0].classList.add('FAILED');
             SetSystemStatus()
         }
     });
   }


  function SetSystemStatus(){

    if($('.FAILED').length == 0 ){
      $('#SystemStatus')[0].innerHTML = "WORKING"
      $('#SystemStatus')[0].style.color = 'Green';
    } else {
      $('#SystemStatus')[0].innerHTML = "FAILING"
      $('#SystemStatus')[0].style.color = 'red';
    }
  }




  /* ###### */
  for (let i = 0; i < 1000; i++) {

    setTimeout(function(){
      $(".FAILED").fadeIn();
    }, 800);
    setTimeout(function(){
      $(".FAILED").fadeOut();
    }, 800);
  }

</script>
